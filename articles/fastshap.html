<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="fastshap">
<title>fastshap • fastshap</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="fastshap">
<meta property="og:description" content="fastshap">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">fastshap</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item">
  <a class="nav-link" href="../articles/fastshap.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/bgreenwell/fastshap/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>fastshap</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/bgreenwell/fastshap/blob/HEAD/vignettes/fastshap.Rmd" class="external-link"><code>vignettes/fastshap.Rmd</code></a></small>
      <div class="d-none name"><code>fastshap.Rmd</code></div>
    </div>

    
    
<p>In this vignette, we’ll cover basic usage of <a href="https://cran.r-project.org/package=fastshap" class="external-link">fastshap</a> for
computing feature contributions for both local and global explanations,
and show how to visualize the output using the <a href="https://cran.r-project.org/package=shapviz" class="external-link">shapviz</a> package.
To start, we’ll use the <a href="https://cran.r-project.org/package=ranger" class="external-link">ranger</a> package to
build a random forest to predict (and explain) survivability of
passengers on the ill-fated Titanic.</p>
<p>The <a href="https://hbiostat.org/data/" class="external-link">source data</a> (also
available in <code><a href="../reference/titanic.html">fastshap::titanic</a></code>) contains 263 missing values
(i.e., <code>NA</code>’s) in the age column. The
<code>titanic_mice</code> version, which we’ll use in this vignette,
contains imputed values for the age column using <em>multivariate
imputation by chained equations</em> via the <a href="https://cran.r-project.org/package=mice" class="external-link">mice</a> package.
Consequently, <code>titanic_mice</code> is a list containing 11 imputed
versions of the original data; see <code><a href="../reference/titanic_mice.html">?fastshap::titanic_mice</a></code>
for details. For now, we’ll just use one of the 11 imputed versions:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/bgreenwell/fastshap" class="external-link">fastshap</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">t1</span> <span class="op">&lt;-</span> <span class="va">titanic_mice</span><span class="op">[[</span><span class="fl">1L</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   survived pclass   age    sex sibsp parch</span></span>
<span><span class="co">## 1      yes      1 29.00 female     0     0</span></span>
<span><span class="co">## 2      yes      1  0.92   male     1     2</span></span>
<span><span class="co">## 3       no      1  2.00 female     1     2</span></span>
<span><span class="co">## 4       no      1 30.00   male     1     2</span></span>
<span><span class="co">## 5       no      1 25.00 female     1     2</span></span>
<span><span class="co">## 6      yes      1 48.00   male     0     0</span></span></code></pre>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">t1</span><span class="op">$</span><span class="va">pclass</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.ordered</a></span><span class="op">(</span><span class="va">t1</span><span class="op">$</span><span class="va">pclass</span><span class="op">)</span>  <span class="co"># makes more sense as an ordered factor</span></span></code></pre></div>
<p>Next, we’ll build a default <a href="https://doi.org/10.3414/ME00-01-0052" class="external-link"><em>probability
forest</em></a> which uses the <em>Brier score</em> to determine
splits.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/imbs-hl/ranger" class="external-link">ranger</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">2053</span><span class="op">)</span>  <span class="co"># for reproducibility</span></span>
<span><span class="op">(</span><span class="va">rfo</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ranger/man/ranger.html" class="external-link">ranger</a></span><span class="op">(</span><span class="va">survived</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">t1</span>, probability <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Ranger result</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Call:</span></span>
<span><span class="co">##  ranger(survived ~ ., data = t1, probability = TRUE) </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Type:                             Probability estimation </span></span>
<span><span class="co">## Number of trees:                  500 </span></span>
<span><span class="co">## Sample size:                      1309 </span></span>
<span><span class="co">## Number of independent variables:  5 </span></span>
<span><span class="co">## Mtry:                             2 </span></span>
<span><span class="co">## Target node size:                 10 </span></span>
<span><span class="co">## Variable importance mode:         none </span></span>
<span><span class="co">## Splitrule:                        gini </span></span>
<span><span class="co">## OOB prediction error (Brier s.):  0.1341913</span></span></code></pre>
<div class="section level2">
<h2 id="local-explanations">Local explanations<a class="anchor" aria-label="anchor" href="#local-explanations"></a>
</h2>
<p>To illustrate the simplest use of Shapley values for quantifying
feature contributions, we need an observation to predict. While we can
use any observation from the training set, we’ll construct an
observation for a new passenger. Everyone, meet Jack:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">jack.dawson</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  <span class="co">#survived = 0L,  # in case you haven't seen the movie</span></span>
<span>  pclass <span class="op">=</span> <span class="fl">3L</span>,     <span class="co"># third-class passenger</span></span>
<span>  age <span class="op">=</span> <span class="fl">20.0</span>,      <span class="co"># twenty years old</span></span>
<span>  sex <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="st">"male"</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"female"</span>, <span class="st">"male"</span><span class="op">)</span><span class="op">)</span>,  <span class="co"># male</span></span>
<span>  sibsp <span class="op">=</span> <span class="fl">0L</span>,      <span class="co"># no siblings/spouses aboard</span></span>
<span>  parch <span class="op">=</span> <span class="fl">0L</span>       <span class="co"># no parents/children aboard</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Note that <a href="https://cran.r-project.org/package=fastshap" class="external-link">fastshap</a>, like
many other <a href="https://christophm.github.io/interpretable-ml-book/" class="external-link">machine
learning interpretability</a> packages (e.g., <a href="https://cran.r-project.org/package=iml" class="external-link">iml</a>), requires a
user-specified prediction wrapper; that is, a simple function that tells
<a href="https://cran.r-project.org/package=fastshap" class="external-link">fastshap</a> how
to extract the appropriate predictions from the fitted model. In this
case, we want to explain Jack’s likelihood of survival, so our
prediction wrapper<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content='&lt;p&gt;As described in &lt;code&gt;&lt;a href="../reference/explain.html"&gt;?fastshap::explain&lt;/a&gt;&lt;/code&gt;, the
prediction wrapper requires two arguments, &lt;code&gt;object&lt;/code&gt; and
&lt;code&gt;newdata&lt;/code&gt;.&lt;/p&gt;'><sup>1</sup></a> needs to return the conditional probability
of surviving from a fitted <a href="https://cran.r-project.org/package=fastshap" class="external-link">ranger</a> object;
see <code><a href="https://rdrr.io/pkg/ranger/man/predict.ranger.html" class="external-link">?ranger::predict.ranger</a></code> for details:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pfun</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">object</span>, <span class="va">newdata</span><span class="op">)</span> <span class="op">{</span>  <span class="co"># prediction wrapper</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/unname.html" class="external-link">unname</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">object</span>, data <span class="op">=</span> <span class="va">newdata</span><span class="op">)</span><span class="op">$</span><span class="va">predictions</span><span class="op">[</span>, <span class="st">"yes"</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Compute Jack's predicted likelihood of survival</span></span>
<span><span class="op">(</span><span class="va">jack.prob</span> <span class="op">&lt;-</span> <span class="fu">pfun</span><span class="op">(</span><span class="va">rfo</span>, newdata <span class="op">=</span> <span class="va">jack.dawson</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 0.1330587</span></span></code></pre>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Average prediction across all passengers</span></span>
<span><span class="op">(</span><span class="va">baseline</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu">pfun</span><span class="op">(</span><span class="va">rfo</span>, newdata <span class="op">=</span> <span class="va">t1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>  </span></code></pre></div>
<pre><code><span><span class="co">## [1] 0.3815068</span></span></code></pre>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Difference between Jack and average</span></span>
<span><span class="op">(</span><span class="va">difference</span> <span class="op">&lt;-</span> <span class="va">jack.prob</span> <span class="op">-</span> <span class="va">baseline</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] -0.2484481</span></span></code></pre>
<p>Yikes, Jack isn’t predicted to have fared too well on this voyage, at
least compared to the baseline (i.e., average training prediction)! Can
we try to understand why Jack’s predicted likelihood of survival is so
much smaller than the average? Of course, this is the difference
Shapley-based feature contributions help to explain.</p>
<p>To illustrate, we’ll use the <code><a href="../reference/explain.html">explain()</a></code> function to
estimate how each of jack features<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content="&lt;p&gt;Note that we need to supply the training features via
the &lt;code&gt;X&lt;/code&gt; argument (i.e., no response column) and that
&lt;code&gt;newdata&lt;/code&gt; should also only contain columns of feature
values.&lt;/p&gt;"><sup>2</sup></a> (i.e., his age and sex) contributed to the
difference:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">t1</span>, select <span class="op">=</span> <span class="op">-</span><span class="va">survived</span><span class="op">)</span>  <span class="co"># features only</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">2113</span><span class="op">)</span>  <span class="co"># for reproducibility</span></span>
<span><span class="op">(</span><span class="va">ex.jack</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/explain.html">explain</a></span><span class="op">(</span><span class="va">rfo</span>, X <span class="op">=</span> <span class="va">X</span>, pred_wrapper <span class="op">=</span> <span class="va">pfun</span>, newdata <span class="op">=</span> <span class="va">jack.dawson</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##      pclass          age sex      sibsp parch</span></span>
<span><span class="co">## [1,]      0 -0.006721834   0 0.03017177     0</span></span></code></pre>
<p>The <a href="https://cran.r-project.org/package=fastshap" class="external-link">fastshap</a> package
uses an efficient version of the Monte-Carlo (MC) algorithm described in
<span class="citation">@strumbelj-2014-explaining</span>. Consequently,
for stability and accuracy, the feature contributions should be computed
many times and the results averaged together. To accomplish this, simply
set the <code>nsim</code> argument to a reasonably high value (i.e., as
much as you can computationally afford). Below we compute 1000
Shapley-based feature contributions for Jack and average the
results:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">2129</span><span class="op">)</span>  <span class="co"># for reproducibility</span></span>
<span><span class="op">(</span><span class="va">ex.jack</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/explain.html">explain</a></span><span class="op">(</span><span class="va">rfo</span>, X <span class="op">=</span> <span class="va">X</span>, pred_wrapper <span class="op">=</span> <span class="va">pfun</span>, newdata <span class="op">=</span> <span class="va">jack.dawson</span>,</span>
<span>                    nsim <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##           pclass          age        sex       sibsp       parch</span></span>
<span><span class="co">## [1,] -0.07878601 -0.009507426 -0.1417691 0.005069262 -0.01201627</span></span></code></pre>
<p>Note that the MC approach used by <a href="https://cran.r-project.org/package=fastshap" class="external-link">fastshap</a> (and
other packages) will not produce Shapley-based feature contributions
that satisfy the <a href="https://christophm.github.io/interpretable-ml-book/shapley.html#the-shapley-value-in-detail" class="external-link">efficiency
property</a>; that is, they won’t add up to the difference between the
corresponding prediction and baseline (i.e., average training
prediction). However, borrowing a trick from the popular Python <a href="https://github.com/slundberg/shap" class="external-link">shap</a> library, we can use a
regression-based adjustment to correct the sum. To do this, simply set
<code>adjust = TRUE</code> in the call to <code><a href="../reference/explain.html">explain()</a></code><a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content="&lt;p&gt;Note that &lt;code&gt;nsim&lt;/code&gt; has to be larger than one
whenever setting &lt;code&gt;adjust = TRUE&lt;/code&gt;.&lt;/p&gt;"><sup>3</sup></a>:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">2133</span><span class="op">)</span>  <span class="co"># for reproducibility</span></span>
<span><span class="op">(</span><span class="va">ex.jack.adj</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/explain.html">explain</a></span><span class="op">(</span><span class="va">rfo</span>, X <span class="op">=</span> <span class="va">X</span>, pred_wrapper <span class="op">=</span> <span class="va">pfun</span>, newdata <span class="op">=</span> <span class="va">jack.dawson</span>,</span>
<span>                        nsim <span class="op">=</span> <span class="fl">1000</span>, adjust <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##           pclass         age        sex       sibsp       parch</span></span>
<span><span class="co">## [1,] -0.07299993 -0.02063907 -0.1491682 0.007971709 -0.01361257</span></span></code></pre>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Sanity check</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">ex.jack.adj</span><span class="op">)</span>  <span class="co"># should be -0.2484481</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] -0.2484481</span></span></code></pre>
<p>Next, we can use the <a href="https://cran.r-project.org/package=shapviz" class="external-link">shapviz</a> package to
produce several useful visualizations for either a vector or matrix of
Shapley values. Below, we create a simple waterfall chart to visualize
how Jack’s features contributed to his relatively low predicted
probability of surviving:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/ModelOriented/shapviz" class="external-link">shapviz</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">shv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shapviz/man/shapviz.html" class="external-link">shapviz</a></span><span class="op">(</span><span class="va">ex.jack.adj</span>, X <span class="op">=</span> <span class="va">jack.dawson</span>, baseline <span class="op">=</span> <span class="va">baseline</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/shapviz/man/sv_waterfall.html" class="external-link">sv_waterfall</a></span><span class="op">(</span><span class="va">shv</span><span class="op">)</span></span></code></pre></div>
<p><img src="figure/titanic-explain-jack-waterfall-1.png" alt="plot of chunk titanic-explain-jack-waterfall" width="70%"></p>
<p>Clearly, the fact the Jack was a male, third-class passenger
contributed the most to pushing his predicted probability of survival
down below the baseline. <em>Force plots</em> are another popular way to
visualize Shapley values for explaining a single prediction:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/shapviz/man/sv_force.html" class="external-link">sv_force</a></span><span class="op">(</span><span class="va">shv</span><span class="op">)</span></span></code></pre></div>
<p><img src="figure/titanic-explain-jack-force-1.png" alt="plot of chunk titanic-explain-jack-force" width="70%"></p>
<p>Although force plots are cool, waterfall charts seem to be a much
more effective way of visualizing feature contributions for a single
prediction; especially when there’s a large number of features.</p>
</div>
<div class="section level2">
<h2 id="global-explanations">Global explanations<a class="anchor" aria-label="anchor" href="#global-explanations"></a>
</h2>
<p>Aside from explaining individual prediction (i.e., <em>local
explanation</em>), it can be useful to aggregate the results of several
(i.e., all of the training predictions) into an overall global summary
about the model (i.e., global explanations). However, computing Shapley
values for a large number of observations can be quite computationally
expensive, especially when using the MC approach. However, <a href="https://cran.r-project.org/package=fastshap" class="external-link">fastshap</a> is quite
efficient compared to alternative implementations<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content="&lt;p&gt;For large-ish data sets, you should always run
&lt;code&gt;it&lt;/code&gt;explain()&lt;code&gt;on a smaller subsample with&lt;/code&gt;nsim =
1` to gauge how much compute you can afford&lt;/p&gt;"><sup>4</sup></a>. The code chunk below
computes Shapley explanations for each passenger in the training data
using 1000 MC repetitions, and coerces the resulting matrix to a <a href="https://cran.r-project.org/package=tibble" class="external-link">tibble</a> (for nicer
printing).</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">2224</span><span class="op">)</span>  <span class="co"># for reproducibility</span></span>
<span><span class="va">ex.t1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/explain.html">explain</a></span><span class="op">(</span><span class="va">rfo</span>, X <span class="op">=</span> <span class="va">X</span>, pred_wrapper <span class="op">=</span> <span class="va">pfun</span>, nsim <span class="op">=</span> <span class="fl">100</span>, adjust <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                 shap_only <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span><span class="va">ex.t1</span><span class="op">$</span><span class="va">shapley_values</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## # A tibble: 1,309 × 5</span></span>
<span><span class="co">##    pclass      age     sex      sibsp    parch</span></span>
<span><span class="co">##     &lt;dbl&gt;    &lt;dbl&gt;   &lt;dbl&gt;      &lt;dbl&gt;    &lt;dbl&gt;</span></span>
<span><span class="co">##  1  0.231  0.00815  0.315   0.0205    -0.00924</span></span>
<span><span class="co">##  2  0.140  0.330   -0.0767  0.00589    0.0772 </span></span>
<span><span class="co">##  3  0.161  0.0293   0.126  -0.0263    -0.0252 </span></span>
<span><span class="co">##  4  0.214 -0.0231  -0.186   0.0156     0.00436</span></span>
<span><span class="co">##  5  0.193 -0.0328   0.286  -0.0183    -0.0468 </span></span>
<span><span class="co">##  6  0.171 -0.0320  -0.197   0.0000595 -0.00303</span></span>
<span><span class="co">##  7  0.176 -0.127    0.345  -0.0103     0.00340</span></span>
<span><span class="co">##  8  0.151 -0.0713  -0.189  -0.00363   -0.0138 </span></span>
<span><span class="co">##  9  0.239  0.00252  0.296   0.0437     0.00567</span></span>
<span><span class="co">## 10  0.112 -0.111   -0.210   0.00154   -0.00452</span></span>
<span><span class="co">## # ℹ 1,299 more rows</span></span></code></pre>
<p>Note that I set the optional argument <code>shap_only = FALSE</code>
here. This is a convenience argument when working with <a href="https://cran.r-project.org/package=shapviz" class="external-link">shapviz</a>; in short,
setting this to <code>FALSE</code> will return a list containing the
Shapely values, feature values, and baseline (all of which can be used
by <a href="https://cran.r-project.org/package=shapviz" class="external-link">shapviz</a>’s
plotting functions).</p>
<p>A common global measure computed from Shapley values is the
Shapley-based feature importance scores, which are nothing more than the
mean of the absolute value of the features contribution for each
column:</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">shv.global</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shapviz/man/shapviz.html" class="external-link">shapviz</a></span><span class="op">(</span><span class="va">ex.t1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/shapviz/man/sv_importance.html" class="external-link">sv_importance</a></span><span class="op">(</span><span class="va">shv</span><span class="op">)</span>  </span></code></pre></div>
<p><img src="figure/titanic-explain-global-importance-1.png" alt="plot of chunk titanic-explain-global-importance" width="70%"></p>
<p>Another common global visualization is the Shapley dependence plot,
akin to a <a href="https://cran.r-project.org/package=pdp" class="external-link"><em>partial
dependence plot</em></a>. Here, we’ll look at the dependence of the
feature contribution of <code>age</code> on its input value:</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/shapviz/man/sv_dependence.html" class="external-link">sv_dependence</a></span><span class="op">(</span><span class="va">shv.global</span>, v <span class="op">=</span> <span class="st">"age"</span><span class="op">)</span></span></code></pre></div>
<p><img src="figure/titanic-explain-global-dependence-1.png" alt="plot of chunk titanic-explain-global-dependence" width="70%"></p>
</div>
<div class="section level2">
<h2 id="parallel-processing">Parallel processing<a class="anchor" aria-label="anchor" href="#parallel-processing"></a>
</h2>
<p>The <code><a href="../reference/explain.html">explain()</a></code> function computes Shapley values one
column at a time (in a very efficient way). However, if you have a lot
of features, it may be beneficial to run <code><a href="../reference/explain.html">explain()</a></code> in
parallel across all the columns. Since <code><a href="../reference/explain.html">explain()</a></code> uses <a href="https://cran.r-project.org/package=foreach" class="external-link">foreach</a> to loop
through features when computing Shapley values, you can use any parallel
backend it support; for details, see the parallel execution section of
the “Using the <code>foreach</code> package” vignette, which you can
view with <code><a href="https://cran.rstudio.com/web/packages/foreach/vignettes/foreach.html" class="external-link">vignette("foreach", package = "foreach")</a></code>.</p>
<p>To illustrate, we’ll compute Shapley values from a random forest fit
to the Ames housing data available in the <a href="https://cran.r-project.org/package=AmesHousing" class="external-link">AmesHousing</a>
package:</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ames</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="fu">AmesHousing</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/AmesHousing/man/make_ames.html" class="external-link">make_ames</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">ames</span>, select <span class="op">=</span> <span class="op">-</span><span class="va">Sale_Price</span><span class="op">)</span>  <span class="co"># features only</span></span>
<span></span>
<span><span class="co"># Fit a random forest</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">102</span><span class="op">)</span></span>
<span><span class="op">(</span><span class="va">rfo</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ranger/man/ranger.html" class="external-link">ranger</a></span><span class="op">(</span><span class="va">Sale_Price</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span>  <span class="va">ames</span>, write.forest <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Ranger result</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Call:</span></span>
<span><span class="co">##  ranger(Sale_Price ~ ., data = ames, write.forest = TRUE) </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Type:                             Regression </span></span>
<span><span class="co">## Number of trees:                  500 </span></span>
<span><span class="co">## Sample size:                      2930 </span></span>
<span><span class="co">## Number of independent variables:  80 </span></span>
<span><span class="co">## Mtry:                             8 </span></span>
<span><span class="co">## Target node size:                 5 </span></span>
<span><span class="co">## Variable importance mode:         none </span></span>
<span><span class="co">## Splitrule:                        variance </span></span>
<span><span class="co">## OOB prediction error (MSE):       622600969 </span></span>
<span><span class="co">## R squared (OOB):                  0.9024424</span></span></code></pre>
<p>Again, we’ll define the required prediction wrapper and call the
<code><a href="../reference/explain.html">explain()</a></code> function without passing anything to
<code>newdata</code> (i.e., Shapley values for the predictions of every
row in <code>X</code> will be computed):</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Prediction wrapper</span></span>
<span><span class="va">pfun</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">object</span>, <span class="va">newdata</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">object</span>, data <span class="op">=</span> <span class="va">newdata</span><span class="op">)</span><span class="op">$</span><span class="va">predictions</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Without parallelism</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1706</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="op">{</span>  <span class="co"># estimate run time</span></span>
<span>  <span class="va">ex.ames.nonpar</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/explain.html">explain</a></span><span class="op">(</span><span class="va">rfo</span>, X <span class="op">=</span> <span class="va">X</span>, pred_wrapper <span class="op">=</span> <span class="va">pfun</span>, nsim <span class="op">=</span> <span class="fl">50</span>,</span>
<span>                            adjust <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##     user   system  elapsed </span></span>
<span><span class="co">## 2402.172  216.711  898.679</span></span></code></pre>
<p>Honestly, not that bad for 50 MC repetitions on a data set with 80
features on 2930 rows!</p>
<p>For comparison, we’ll run the same computation, but this time in
parallel using the <a href="https://cran.r-project.org/package=doParallel" class="external-link">doParallel</a>
package to execute across 12 cores:</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RevolutionAnalytics/doparallel" class="external-link">doParallel</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># With parallelism</span></span>
<span><span class="fu">registerDoParallel</span><span class="op">(</span>cores <span class="op">=</span> <span class="fl">12</span><span class="op">)</span>  <span class="co"># use forking with 12 cores</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">5038</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="op">{</span>  <span class="co"># estimate run time</span></span>
<span>  <span class="va">ex.ames.par</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/explain.html">explain</a></span><span class="op">(</span><span class="va">rfo</span>, X <span class="op">=</span> <span class="va">X</span>, pred_wrapper <span class="op">=</span> <span class="va">pfun</span>, nsim <span class="op">=</span> <span class="fl">50</span>, </span>
<span>                         adjust <span class="op">=</span> <span class="cn">TRUE</span>, parallel <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##    user  system elapsed </span></span>
<span><span class="co">##   0.948   0.632 265.087</span></span></code></pre>
<p>Not a bad speedup!</p>
<p>Since we didn’t set <code>shap_only=FALSE</code> in the call to
<code><a href="../reference/explain.html">explain()</a></code>, we’ll need to pass the corresponding feature
values and baseline when interfacing with <a href="https://cran.r-project.org/package=shapviz" class="external-link">shapviz</a>. By
default, as long as <code>adjust = TRUE</code>, the baseline will be
automatically computed as the average training prediction (or whatever
suitable background feature set is provided via <code>X</code>) and
stored in the <code>"baseline"</code> of the returned matrix when
<code>shap_only=TRUE</code>, or the <code>"baseline"</code> component of
the returned object when <code>shap_only=FALSE</code>.</p>
<p>For instance, to construct a Shapley-based variable importance plot
from the <code>ex.ames.par</code> object, we can simply do the
following:</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">baseline</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">ex.ames.par</span>, <span class="st">"baseline"</span><span class="op">)</span></span>
<span><span class="va">shv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shapviz/man/shapviz.html" class="external-link">shapviz</a></span><span class="op">(</span><span class="va">ex.ames.par</span>, X <span class="op">=</span> <span class="va">X</span>, baseline <span class="op">=</span> <span class="va">baseline</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/shapviz/man/sv_importance.html" class="external-link">sv_importance</a></span><span class="op">(</span><span class="va">shv</span><span class="op">)</span></span></code></pre></div>
<p><img src="figure/ames-explain-global-parallel-importance-1.png" alt="plot of chunk ames-explain-global-parallel-importance" width="70%"></p>
<p>Similar for Shapley-based dependence plots:</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/shapviz/man/sv_dependence.html" class="external-link">sv_dependence</a></span><span class="op">(</span><span class="va">shv</span>, v <span class="op">=</span> <span class="st">"Gr_Liv_Area"</span>, alpha <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span></span></code></pre></div>
<p><img src="figure/ames-explain-global-parallel-dependence-1.png" alt="plot of chunk ames-explain-global-parallel-dependence" width="70%"></p>
</div>

  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Brandon Greenwell.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
